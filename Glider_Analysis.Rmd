---
title: "Analyzing Glider Data"
subtitle: "EOS 518"
author: '[Dominique Maucieri](https://www.dominiquemaucieri.com)'
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
    toc: yes
    toc_depth: 3
---

```{r installing packages, include=FALSE}

#To clear the workspace
rm(list = ls(all = T))

#My theme
theme_DOM <- function () {
  theme_classic(base_size = 12) + 
    theme(
    panel.border = element_rect(colour = "black", fill = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black"),
    axis.title = element_text(size = 14, face = "bold"),
    axis.text = element_text(size = 12, face = "plain"),
    legend.text = element_text(size = 12, face = "plain"),
    legend.title = element_text(size = 14, face = "bold")
  )
}

# install.packages("rerddap")
library("rerddap")
library("dplyr")
library("ggplot2")
library("lubridate")
library("viridis")
library("scales")
library("rnaturalearth")
library("rnaturalearthdata")
library("ggspatial")
library("geosphere")

```

```{r getting glider_320 data, echo=FALSE, warning=FALSE, tidy = TRUE, message=FALSE}

urlBase <- "https://gliders.ioos.us/erddap"
glider_320Info <- info("ce_320-20220720T1429",  url = urlBase)
glider_320 <- tabledap(glider_320Info, fields = c("longitude", "latitude", "time", "depth", "salinity", "chlorophyll", "dissolved_oxygen", "backscatter", "temperature"), 'time>=2022-08-03 20:05:54+00:00', 'time<=2022-08-07 11:41:59+00:00', url = urlBase)

glider_320$ID <- "320_shallow"


glider_320$longitude <- as.numeric(glider_320$longitude)
glider_320$latitude <- as.numeric(glider_320$latitude)
glider_320$depth <- as.numeric(glider_320$depth)
glider_320$dissolved_oxygen <- as.numeric(glider_320$dissolved_oxygen)
glider_320$temperature <- as.numeric(glider_320$temperature)

glider_320$time2 <- as_datetime(glider_320$time)
glider_320$date <- as.Date(glider_320$time2, format ="%Y-%m-%d")

```


```{r getting glider_383 data, echo=FALSE, warning=FALSE, tidy = TRUE, message=FALSE}

urlBase <- "https://gliders.ioos.us/erddap"
glider_383Info <- info("ce_383-20220720T1508",  url = urlBase)
glider_383 <- tabledap(glider_383Info, fields = c("longitude", "latitude", "time", "depth", "salinity", "chlorophyll", "dissolved_oxygen", "backscatter", "temperature"), 'time>=2022-08-06 00:00:00+00:00', 'time<=2022-08-11 19:54:11+00:00', url = urlBase)

glider_383$ID <- "383_deep"


glider_383$longitude <- as.numeric(glider_383$longitude)
glider_383$latitude <- as.numeric(glider_383$latitude)
glider_383$depth <- as.numeric(glider_383$depth)
glider_383$dissolved_oxygen <- as.numeric(glider_383$dissolved_oxygen)
glider_383$temperature <- as.numeric(glider_383$temperature)

glider_383$time2 <- as_datetime(glider_383$time)
glider_383$date <- as.Date(glider_383$time2, format ="%Y-%m-%d")

```


```{r path map 320, echo=FALSE, warning=FALSE, tidy = TRUE, message=FALSE}

ggplot(glider_320, aes(x=longitude, y = latitude)) +
  geom_point(aes(col = date)) +
  scale_color_viridis(name='Date', 
                      trans = "date", 
                      labels = label_date(format = "%Y-%m-%d") ) + 
  theme_DOM() + 
  labs(x ="Longitude", y="Latitude")

```


```{r path map 383, echo=FALSE, warning=FALSE, tidy = TRUE, message=FALSE}

ggplot(glider_383, aes(x=longitude, y = latitude)) +
  geom_point(aes(col = date)) +
  scale_color_viridis(name='Date', 
                      trans = "date", 
                      labels = label_date(format = "%Y-%m-%d") ) + 
  theme_DOM() + 
  ylim(c(46.75, 47.25)) + 
  labs(x ="Longitude", y="Latitude")

```

```{r map with shore, echo=FALSE, warning=FALSE, tidy = TRUE, message=FALSE}

glider <- rbind(glider_320, glider_383)

shore <- c(-124.19208, 47.15073)

max_lat_map <- max(c(glider$latitude, shore[2])) + 0.25
min_lat_map <- min(c(glider$latitude, shore[2])) - 0.25

max_long_map <- max(c(glider$longitude, shore[1])) + 0.25
min_long_map <- min(c(glider$longitude, shore[1])) - 0.25


world <- ne_countries(scale = "medium", returnclass = "sf")

simple_map <- ggplot(data = world) +
  geom_sf() +
  annotation_scale(location = "bl", width_hint = 0.5) +
  annotation_north_arrow(
    location = "tl",
    which_north = "true",
    style = north_arrow_fancy_orienteering
  ) +
  coord_sf(
    xlim = c(min_long_map, max_long_map),
    ylim = c(min_lat_map, max_lat_map)
  ) +
  theme_DOM() +
  geom_point(
    data = glider,
    aes(
      x = longitude,
      y = latitude,
      color = ID
    ),
    size = 2
  ) +
  scale_color_manual(values = c("darkblue", "darkgreen")) +
  labs(x = "Longitude", y = "Latitude") +
  geom_point(aes(x=shore[1], y=shore[2]), colour="red")

simple_map

```


```{r profile quick and bad way, echo=FALSE, warning=FALSE, tidy = TRUE, message=FALSE}

ggplot(glider, aes(y=-depth, x= time2)) +
  geom_point(aes(col = temperature)) + 
  theme_DOM() +
  scale_color_viridis() +
  facet_wrap(vars(ID), scales = "free") + 
  labs(x ="Date", y="Depth (m)")

```


```{r calc distance from shore, echo=FALSE, warning=FALSE, tidy = TRUE, message=FALSE}

glider$distance <- "Blank"

for(i in 1:nrow(glider)){
  glider$distance[i] <- distm(c(glider$longitude[i], glider$latitude[i]), shore)
}

glider$distance <- as.numeric(glider$distance)

glider$distance_km <- glider$distance / 1000

```


```{r profile distance from shore, echo=FALSE, warning=FALSE, tidy = TRUE, message=FALSE}

ggplot(glider, aes(y=-depth, x= distance_km)) +
  geom_point(aes(col = temperature)) + 
  theme_DOM() +
  scale_color_viridis() +
  facet_wrap(vars(ID), scales = "free") + 
  labs(x ="Distance from shore (m)", y="Depth (km)")

```



```{r depth by temperature, echo=FALSE, warning=FALSE, tidy = TRUE, message=FALSE}

glider$temperature <- as.numeric(glider$temperature)

ggplot(glider, aes(x=depth, y= temperature)) +
  geom_point(aes(col = date)) +
  scale_color_viridis(name='Date', 
                      trans = "date", 
                      labels = label_date(format = "%Y-%m-%d") ) + 
  theme_DOM() +
  facet_wrap(vars(ID), scales = "free") + 
  labs(x ="Depth", y="Temperature")

```





```{r depth by DO, echo=FALSE, warning=FALSE, tidy = TRUE, message=FALSE}

glider$dissolved_oxygen_2 <- glider$dissolved_oxygen / 43.57

ggplot(glider, aes(x=depth, y=dissolved_oxygen_2)) +
  geom_point(aes(col = date)) +
  scale_color_viridis(name='Date', 
                      trans = "date", 
                      labels = label_date(format = "%Y-%m-%d") ) + 
  theme_DOM() +
  geom_hline(yintercept = 1.4, color = "red") +
  geom_hline(yintercept = 0.5, color = "red")+
  facet_wrap(vars(ID), scales = "free") + 
  labs(x ="Depth", y="Dissolved Oxygen (ml/L)")

```


